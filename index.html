import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, Calendar, BookOpen } from 'lucide-react';

const StudyTimerApp = () => {
  // Initialize totalHours first
  const [totalHours, setTotalHours] = useState(20);
  const [mainTime, setMainTime] = useState(totalHours * 60 * 60);
  const [sessionTime, setSessionTime] = useState(60 * 60);
  const [isRunning, setIsRunning] = useState(false);
  const [isBreak, setIsBreak] = useState(false);
  const [breakTime, setBreakTime] = useState(5 * 60);
  const [currentStudyTopic, setCurrentStudyTopic] = useState('Programming');
  const [studyHistory, setStudyHistory] = useState({});
  const [customTopics, setCustomTopics] = useState([]);
  const [newTopicInput, setNewTopicInput] = useState('');

  const intervalRef = useRef(null);

  useEffect(() => {
    if (!isRunning) {
      setMainTime(totalHours * 60 * 60);
    }
  }, [totalHours, isRunning]);

  useEffect(() => {
    if (isRunning && !isBreak) {
      intervalRef.current = setInterval(() => {
        setSessionTime(prev => {
          if (prev <= 1) {
            setIsBreak(true);
            setBreakTime(5 * 60);
            return 60 * 60;
          }
          return prev - 1;
        });
        setMainTime(prev => Math.max(0, prev - 1));
      }, 1000);
    } else if (isRunning && isBreak) {
      intervalRef.current = setInterval(() => {
        setBreakTime(prev => {
          if (prev <= 1) {
            setIsBreak(false);
            recordStudySession();
            return 5 * 60;
          }
          return prev - 1;
        });
      }, 1000);
    } else {
      clearInterval(intervalRef.current);
    }

    return () => clearInterval(intervalRef.current);
  }, [isRunning, isBreak]);

  const recordStudySession = () => {
    const today = new Date().toISOString().split('T')[0];
    setStudyHistory(prev => ({
      ...prev,
      [today]: {
        sessions: (prev[today]?.sessions || 0) + 1,
        minutes: (prev[today]?.minutes || 0) + 60,
        topic: currentStudyTopic,
      },
    }));
  };

  const toggleTimer = () => setIsRunning(!isRunning);

  const resetTimers = () => {
    setIsRunning(false);
    setIsBreak(false);
    setMainTime(totalHours * 60 * 60);
    setSessionTime(60 * 60);
    setBreakTime(5 * 60);
  };

  const formatTime = (seconds) => {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return h > 0
      ? `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`
      : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  const getCircleProgress = (current, total) => ((total - current) / total) * 100;

  const addCustomTopic = () => {
    const topic = newTopicInput.trim();
    if (topic && !getAllTopics().includes(topic)) {
      setCustomTopics([...customTopics, topic]);
      setNewTopicInput('');
    }
  };

  const getAllTopics = () => [...studyTopics, ...customTopics];

  const getIntensityColor = (sessions) => {
    if (sessions === 0) return 'bg-gray-800';
    if (sessions === 1) return 'bg-green-300';
    if (sessions === 2) return 'bg-green-500';
    if (sessions >= 3) return 'bg-green-700';
    return 'bg-green-600';
  };

  const generateCalendarGrid = () => {
    const today = new Date();
    const grid = [];
    for (let col = 0; col < 15; col++) {
      const column = [];
      for (let row = 0; row < 6; row++) {
        const dayOffset = Math.floor(col * 2 + row / 3);
        const date = new Date(today);
        date.setDate(today.getDate() - (29 - dayOffset));
        const dateStr = date.toISOString().split('T')[0];
        column.push({
          date: dateStr,
          sessions: studyHistory[dateStr]?.sessions || 0,
        });
      }
      grid.push(column);
    }
    return grid;
  };

  const studyTopics = ['Programming', 'Mathematics', 'Science', 'Languages', 'Design', 'Business', 'Art', 'Music'];

  return (
    <div className="min-h-screen text-white relative overflow-x-hidden">
      {/* Background: dark grainy */}
      <div className="absolute inset-0 bg-[#0a0a0a] opacity-100" style={{
        backgroundImage: `radial-gradient(circle at 20% 30%, rgba(255,255,255,0.03) 0%, transparent 50%), 
                         radial-gradient(circle at 80% 70%, rgba(255,255,255,0.03) 0%, transparent 50%),
                         radial-gradient(circle at 40% 80%, rgba(255,255,255,0.02) 0%, transparent 50%)`,
        backgroundSize: '100% 100%',
        backgroundBlendMode: 'overlay',
      }} />

      {/* Content */}
      <div className="relative z-10 p-4 max-w-md mx-auto">
        <div className="text-center mb-6">
          <div className="flex items-center justify-center gap-2 mb-2">
            <BookOpen className="w-6 h-6" />
            <h1 className="text-2xl font-bold">Study Timer</h1>
          </div>
          <select
            value={currentStudyTopic}
            onChange={(e) => setCurrentStudyTopic(e.target.value)}
            className="bg-white/10 border border-white/20 rounded-lg px-3 py-1 text-sm backdrop-blur-sm mb-3"
          >
            {getAllTopics().map(topic => (
              <option key={topic} value={topic} className="bg-black">{topic}</option>
            ))}
          </select>

          <div className="flex items-center gap-2 mb-3">
            <input
              type="text"
              value={newTopicInput}
              onChange={(e) => setNewTopicInput(e.target.value)}
              placeholder="Add new topic"
              onKeyDown={(e) => e.key === 'Enter' && addCustomTopic()}
              className="flex-1 bg-white/10 border border-white/20 rounded-lg px-3 py-1 text-sm"
            />
            <button onClick={addCustomTopic} className="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-lg text-sm">
              Add
            </button>
          </div>

          <div className="flex items-center justify-center gap-2">
            <label className="text-sm">Total Hours:</label>
            <input
              type="number"
              value={totalHours}
              onChange={(e) => setTotalHours(Math.max(1, parseInt(e.target.value) || 1))}
              min="1"
              max="24"
              className="bg-white/10 border border-white/20 rounded-lg px-3 py-1 text-sm w-16 text-center"
              disabled={isRunning}
            />
          </div>
        </div>

        {/* Timer Display */}
        <div className="relative mb-8">
          <div className="relative w-72 h-72 mx-auto">
            <svg className="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" stroke="rgba(255,255,255,0.1)" strokeWidth="2" fill="none" />
              <circle
                cx="50"
                cy="50"
                r="45"
                stroke="url(#gradient-main)"
                strokeWidth="2"
                fill="none"
                strokeDasharray={2 * Math.PI * 45}
                strokeDashoffset={2 * Math.PI * 45 * (1 - getCircleProgress(mainTime, totalHours * 60 * 60) / 100)}
                className="transition-all duration-1000"
              />
              <defs>
                <linearGradient id="gradient-main" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#60a5fa" />
                  <stop offset="100%" stopColor="#3b82f6" />
                </linearGradient>
              </defs>
            </svg>

            <div className="absolute inset-8">
              <svg className="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="rgba(255,255,255,0.1)" strokeWidth="3" fill="none" />
                <circle
                  cx="50"
                  cy="50"
                  r="40"
                  stroke={isBreak ? "#facc15" : "#10b981"}
                  strokeWidth="3"
                  fill="none"
                  strokeDasharray={2 * Math.PI * 40}
                  strokeDashoffset={2 * Math.PI * 40 * (1 - getCircleProgress(isBreak ? breakTime : sessionTime, isBreak ? 5 * 60 : 60 * 60) / 100)}
                  className="transition-all duration-1000"
                />
              </svg>

              <div className="absolute inset-0 flex flex-col items-center justify-center">
                <div className="text-xs text-gray-400 mb-1">{isBreak ? 'Break Time' : 'Study Session'}</div>
                <div className="text-3xl font-mono font-bold mb-2">{formatTime(isBreak ? breakTime : sessionTime)}</div>
                <div className="text-sm text-gray-400">Daily: {formatTime(mainTime)}</div>
              </div>
            </div>
          </div>
        </div>

        {/* Controls */}
        <div className="flex justify-center gap-4 mb-8">
          <button onClick={toggleTimer}
            className={`flex items-center gap-2 px-6 py-2 rounded-full font-semibold ${isRunning ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}>
            {isRunning ? <Pause className="w-5 h-5" /> : <Play className="w-5 h-5" />}
            {isRunning ? 'Pause' : 'Start'}
          </button>
          <button onClick={resetTimers} className="flex items-center gap-2 px-6 py-2 rounded-full bg-gray-600 hover:bg-gray-700 font-semibold">
            <RotateCcw className="w-5 h-5" />
            Reset
          </button>
        </div>

        {/* Study History */}
        <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4">
          <div className="flex items-center gap-2 mb-4">
            <Calendar className="w-4 h-4" />
            <h3 className="text-lg font-semibold">Study History</h3>
          </div>
          <div className="text-sm text-gray-300 mb-2">
            {Object.values(studyHistory).reduce((acc, day) => acc + (day.sessions || 0), 0)} sessions completed
          </div>

          <div className="grid" style={{ gridTemplateColumns: 'repeat(15, 1fr)', gap: '2px' }}>
            {generateCalendarGrid().map((col, colIndex) =>
              col.map((tile, rowIndex) => (
                <div
                  key={`${colIndex}-${rowIndex}`}
                  className={`w-3 h-3 rounded-sm ${getIntensityColor(tile.sessions)} transition-all hover:scale-110`}
                  title={`${tile.date}: ${tile.sessions} sessions`}
                />
              ))
            )}
          </div>

          <div className="flex items-center justify-between text-xs text-gray-400 mt-2">
            <span>Less</span>
            <div className="flex gap-1">
              <div className="w-3 h-3 bg-gray-800 rounded-sm" />
              <div className="w-3 h-3 bg-green-300 rounded-sm" />
              <div className="w-3 h-3 bg-green-500 rounded-sm" />
              <div className="w-3 h-3 bg-green-700 rounded-sm" />
            </div>
            <span>More</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default StudyTimerApp;
